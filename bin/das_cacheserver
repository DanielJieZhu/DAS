#!/usr/bin/env bash
#
# CMS DAS cache server
#
# chkconfig: 345 05 95

ver="cms"
if [ -z ${WMCORE_ROOT} ]; then
   echo "The WMCORE_ROOT environment is not set"
   echo "Will switch to stand-alone mode"
   ver="stand_alone"
else
   export WTBASE=$WMCORE_ROOT/src
fi
if [ -z $DAS_ROOT ]; then
   echo "The DAS_ROOT environment is not set"
   exit 1
fi

RETVAL=$?

mongo_pid=`ps auxwww | grep mongod | grep -v grep | awk '{print $2}'`
if [ -z $mongo_pid ]; then
   echo "No MongoDB PID found, please start MongoDB first"
   exit 1
fi

if [ ${ver} == "stand_alone" ]; then
cmd="$DAS_ROOT/src/python/DAS/web/das_server.py --cache-server"
pid=`ps auxwwwww | grep das_server | grep cache-server | grep -v grep | awk '{print $2}'`
else
cmd="$WMCORE_ROOT/src/python/WMCore/WebTools/Root.py --ini=$DAS_ROOT/src/python/DAS/web/das_cacheconfig.py"
pid=`ps auxwwwww | grep das_cacheconfig | grep -v grep | awk 'BEGIN{ORS=" "} {print $2}'`
fi

case "$1" in
 stdout)
        echo $"Checking for existing DAS service..."
        if [ ! -z "${pid}" ]; then
          kill -9 ${pid}
        fi
        echo $"Restart DAS service..."
        ${cmd}
        ;;
 restart)
        echo $"Checking for existing DAS service..."
        if [ ! -z "${pid}" ]; then
          kill -9 ${pid}
        fi
        echo $"Restart DAS service..."
        nohup ${cmd} 2>&1 1>& /dev/null < /dev/null &
        ;;
 start)
        if [ ! -z "${pid}" ]; then
          kill -9 ${pid}
        fi
        nohup ${cmd} 2>&1 1>& /dev/null < /dev/null &
        ;;
 status)
        if [ ! -z "${pid}" ]; then
          echo $"DAS is running, pid=${pid}"
          ps -f -wwww -p ${pid}
          exit 0
        fi
        echo $"DAS is stopped"
        exit 3
        ;;
 stop)
        if [ ! -z "${pid}" ]; then
          kill -9 ${pid}
        fi
        ;;
 *)
        echo $"Usage: $0 {start|stop|status|restart|stdout}"
        exit 1
        ;;
esac

exit $RETVAL

