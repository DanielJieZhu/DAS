#!/bin/bash

# helper function to clean-up DAS mapping db and upload new maps
# $1 is a script to clean-up 
upload_das_maps()
{
    local port=8230
    local db="mapping"
    local col="db"
    local epoch=`date "+%s"`
    local backup="das_maps_$epoch.js"
    echo "Back-up DAS $db.$col: $backup"
    mongoexport --port $port -d $db -c $col > $backup
    echo "Clean-up DAS $db.$col"
    mongo --port $port --eval "mapping=db.getSisterDB(\"mapping\");mapping.dropDatabase();"
    echo "Upload DAS maps into $db.$col"
    mongoimport --port $port -d $db -c $col --file $1
    local status=$?
    if [ $status -ne 0 ]; then
        echo "Fail to import new DAS maps, revert back-up"
        mongoimport --port $port -d $db -c $col --file $backup
    fi
    rm $backup
}

if [ -f $1 ]; then
    upload_das_maps "$1"
else
    echo "Invalid input file"
fi
